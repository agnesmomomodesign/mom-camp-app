<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœ²ç‡Ÿæ´»å‹•å ±åè¡¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®šå­—é«”ç‚º Interï¼Œä¸¦ç‚ºä¸­æ–‡è¨­å®šé€šç”¨å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f7f7f7;
        }
        .form-label {
            font-size: 1.5rem; /* å¤§å­—é«” */
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1f2937; /* æ·±è‰²æ–‡å­— */
        }
        .input-field {
            padding: 1rem;
            border-radius: 0.5rem;
            border: 2px solid #d1d5db;
            width: 100%;
            font-size: 1.25rem;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .registration-item {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background-color: white;
            transition: all 0.3s;
        }
        .registration-item:hover {
            background-color: #f3f4f6;
        }
        .fee-undefined {
            color: #ef4444; /* red-500 */
            font-weight: 700;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto space-y-8">
        
        <!-- æ‡‰ç”¨ç¨‹å¼æ¨™é¡Œèˆ‡èªªæ˜ -->
        <header class="text-center space-y-2">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-700">11/28~30 ç´°æ¹–é ‚éœ²ç‡Ÿå ±å</h1>
            <p class="text-xl font-bold text-red-600">é™é‡40è»Š</p> 
            <p class="text-base text-gray-600">è«‹å¡«å¯«ä»¥ä¸‹è³‡è¨Šï¼Œå®Œæˆå ±åã€‚</p>
            <p class="text-xs text-gray-400">ç”¨æˆ¶ID: <span id="user-id">è®€å–ä¸­...</span></p>
        </header>

        <!-- å ±åè¡¨å–®å€å¡Š -->
        <div id="registration-form" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl space-y-6 border-t-8 border-blue-500">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">å¡«å¯«å ±åè³‡æ–™</h2>

            <!-- 1. å§“å -->
            <div>
                <label for="name" class="form-label">1. å§“å</label>
                <input type="text" id="name" placeholder="è«‹è¼¸å…¥å ±åè€…å§“å" class="input-field" required>
            </div>

            <!-- 2. éš¨è¡Œè»Šè¼›æ•¸ (å·²ä¿®æ”¹ç‚º '2. å¹¾è»Š') -->
            <div>
                <label for="cars" class="form-label">2. å¹¾è»Š</label>
                <input type="number" id="cars" value="1" min="0" class="input-field" required>
            </div>

            <!-- 3. åƒåŠ ç¸½äººæ•¸ -->
            <div>
                <label for="people" class="form-label">3. åƒåŠ ç¸½äººæ•¸ (äºº)</label>
                <input type="number" id="people" value="1" min="1" class="input-field" required>
            </div>
            
            <!-- 4. æŠµé”æ—¥æœŸèˆ‡ä½å®¿é¸æ“‡ -->
            <div class="space-y-4">
                <p class="form-label">4. é¸æ“‡æŠµé”æ—¥æœŸèˆ‡éå¤œæ™šæ•¸</p>
                <div id="arrival-options" class="space-y-3">
                    
                    <!-- é¸é … 1: 11/28 æŠµé”, 2 æ™š -->
                    <label class="flex items-center p-4 bg-blue-50 border-2 border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100 transition duration-150">
                        <input type="radio" name="arrival" value="2025-11-28_2" class="w-6 h-6 text-blue-600 focus:ring-blue-500" required>
                        <span class="ml-4 text-xl font-medium text-gray-800">11æœˆ28æ—¥æŠµé” (å…±ä½ 2 æ™š)</span>
                    </label>

                    <!-- é¸é … 2: 11/29 æŠµé”, 1 æ™š -->
                    <label class="flex items-center p-4 bg-blue-50 border-2 border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100 transition duration-150">
                        <input type="radio" name="arrival" value="2025-11-29_1" class="w-6 h-6 text-blue-600 focus:ring-blue-500">
                        <span class="ml-4 text-xl font-medium text-gray-800">11æœˆ29æ—¥æŠµé” (å…±ä½ 1 æ™š)</span>
                    </label>

                </div>
            </div>

            <!-- æäº¤æŒ‰éˆ• -->
            <button id="submit-btn" onclick="submitRegistration()" class="w-full py-3 px-4 bg-green-500 text-white text-2xl font-bold rounded-xl shadow-lg hover:bg-green-600 transition duration-200 transform hover:scale-[1.01] active:scale-95">
                é€å‡ºå ±å
            </button>
            <div id="message" class="text-center mt-4 text-lg font-medium" style="display: none;"></div>
        </div>

        <!-- å ±åæ¸…å–®å€å¡Š (ä¾›ä¸»è¾¦äººæŸ¥çœ‹) -->
        <div id="registration-list-section" class="pt-8 space-y-4">
            <h2 class="text-3xl font-bold text-gray-800">ç›®å‰å ±åæ¸…å–® (å³æ™‚æ›´æ–°)</h2>
            <div id="totals" class="bg-yellow-50 p-4 rounded-lg shadow font-semibold text-lg flex flex-wrap justify-between">
                <p>ç¸½äººæ•¸: <span id="total-people" class="text-red-600">0</span> äºº</p>
                <p>ç¸½è»Šè¼›æ•¸: <span id="total-cars" class="text-red-600">0</span> å°</p>
                <p>ç¸½è¨ˆè²»ç”¨: <span id="total-fee" class="text-green-700 text-2xl font-extrabold">0</span> å…ƒ</p>
            </div>
            <div id="registrations-container" class="bg-white rounded-xl shadow-lg divide-y divide-gray-200">
                <!-- å ±åè³‡æ–™å°‡è¼‰å…¥æ–¼æ­¤ -->
                <p class="p-6 text-center text-gray-500" id="loading-message">è¼‰å…¥å ±åè³‡æ–™ä¸­...</p>
            </div>
        </div>

    </div>

    <!-- Firebase è…³æœ¬ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase å…¨åŸŸè®Šæ•¸
        let app;
        let db;
        let auth;
        let userId = 'anonymous';

        // === é€™æ˜¯æ‚¨æ­£å¼å°ˆæ¡ˆçš„ Firebase é…ç½® (å·²å…§åµŒæ‚¨æä¾›çš„é‡‘é‘°) ===
        const firebaseConfig = {
          apiKey: "AIzaSyCdSqtWof1b7S-vbJF_0p9BLOqOoTkhORg",
          authDomain: "momcamping-64987.firebaseapp.com",
          projectId: "momcamping-64987",
          storageBucket: "momcamping-64987.firebasestorage.app",
          messagingSenderId: "1029815892072",
          appId: "1:1029815892072:web:a88df6a358db5d31f0e3dd"
        };
        
        // Firestore é›†åˆè·¯å¾‘ (ä½¿ç”¨æ‚¨çš„ projectId ä½œç‚º appId)
        const appId = firebaseConfig.projectId;
        const collectionPath = `/artifacts/${appId}/public/data/camp_registrations`;


        // è¼”åŠ©å‡½å¼ï¼šé¡¯ç¤ºè¨Šæ¯
        function displayMessage(text, isError = false) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            messageElement.style.display = 'block';
            messageElement.className = `text-center mt-4 text-lg font-medium p-3 rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }

        // åˆå§‹åŒ– Firebase
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // å•Ÿç”¨ Firebase åµéŒ¯æ—¥èªŒ

                // è™•ç†èªè­‰
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        // èªè­‰å®Œæˆï¼Œé–‹å§‹ç›£è½è³‡æ–™åº«
                        setupRealtimeListener();
                    } else {
                        // åœ¨æ­£å¼éƒ¨ç½²ç’°å¢ƒä¸­ï¼Œå¦‚æœæ²’æœ‰ç”¨æˆ¶ï¼Œå°±ç›´æ¥ä½¿ç”¨åŒ¿åç™»å…¥
                        await signInAnonymously(auth);
                    }
                });

            } else {
                console.error("éŒ¯èª¤ï¼šFirebase é…ç½®éºå¤±ã€‚è«‹æª¢æŸ¥æ‚¨çš„ index.html æ˜¯å¦åŒ…å«æ­£ç¢ºçš„é‡‘é‘°ã€‚");
                document.getElementById('loading-message').textContent = 'éŒ¯èª¤: Firebase é…ç½®éºå¤±ï¼Œç„¡æ³•è¼‰å…¥è³‡æ–™ã€‚';
            }
        } catch (error) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
            document.getElementById('loading-message').textContent = 'éŒ¯èª¤: Firebase åˆå§‹åŒ–å¤±æ•—ã€‚';
        }

        // è²»ç”¨è¨ˆç®—è¼”åŠ©å‡½å¼
        function calculateFee(people, nights) {
            // è¦å‰‡: 1è»Š2äºº
            if (people === 2) {
                if (nights === 1) return 500;
                if (nights === 2) return 750;
            }
            // è¦å‰‡: 1è»Š1äºº
            else if (people === 1) {
                if (nights === 1) return 400;
                if (nights === 2) return 600;
            }
            // è¦å‰‡æœªå®šç¾© (ä¾‹å¦‚ 0äºº, 3äººä»¥ä¸Š, 3æ™šä»¥ä¸Š)
            return 0; 
        }

        // è¨­ç½®å³æ™‚è³‡æ–™ç›£è½å™¨
        function setupRealtimeListener() {
            if (!db) return;

            // è¼”åŠ©å‡½å¼ï¼šå°‡ Firebase Timestamp æ ¼å¼åŒ–ç‚ºæ˜“è®€çš„ YYYY/MM/DD HH:MM
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'N/A';
                const date = timestamp.toDate();
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                // ç‚ºäº†ç°¡æ½”ï¼Œä¸é¡¯ç¤ºç§’æ•¸
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            };


            const q = query(collection(db, collectionPath));
            const container = document.getElementById('registrations-container');
            const loadingMsg = document.getElementById('loading-message');

            onSnapshot(q, (snapshot) => {
                const registrations = [];
                let totalPeople = 0;
                let totalCars = 0;
                let totalFee = 0; 

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    
                    // è¨ˆç®—å–®ç­†è²»ç”¨
                    const fee = calculateFee(data.people, data.nights);
                    totalFee += fee;
                    data.calculatedFee = fee; // å„²å­˜è¨ˆç®—çµæœä»¥ä¾¿é¡¯ç¤º

                    registrations.push({ id: doc.id, ...data });
                    
                    // è¨ˆç®—ç¸½æ•¸
                    totalPeople += data.people || 0;
                    totalCars += data.cars || 0;
                });
                
                // æ’åºï¼šæŒ‰å ±åæ™‚é–“ã€Œå‡åºã€æ’åˆ— (æœ€æ—©çš„åœ¨æœ€ä¸Šé¢)
                registrations.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

                // æ›´æ–°ç¸½è¨ˆæ•¸å­—
                document.getElementById('total-people').textContent = totalPeople;
                document.getElementById('total-cars').textContent = totalCars;
                document.getElementById('total-fee').textContent = totalFee.toLocaleString('zh-TW'); // æ ¼å¼åŒ–ç‚ºåƒä½æ•¸


                // æ¸²æŸ“æ¸…å–®
                container.innerHTML = '';
                if (registrations.length === 0) {
                    container.innerHTML = '<p class="p-6 text-center text-gray-500">ç›®å‰é‚„æ²’æœ‰äººå ±åï¼Œå¿«ä¾†æˆç‚ºç¬¬ä¸€å€‹å§ï¼</p>';
                } else {
                    // æ–°å¢ index (ç·¨è™Ÿ)
                    registrations.forEach((reg, index) => {
                        const arrivalDateText = reg.arrivalDate.split('_')[0]; 
                        const nightsText = reg.nights; 
                        const formattedTime = formatTimestamp(reg.timestamp); 
                        const sequenceNumber = index + 1; // ç·¨è™Ÿå¾ 1 é–‹å§‹

                        // åˆ¤æ–·æ˜¯å¦ç‚ºæœªå®šç¾©è²»ç”¨
                        const feeDisplay = reg.calculatedFee > 0 
                            ? `<span class="text-green-700 font-bold">${reg.calculatedFee.toLocaleString('zh-TW')} å…ƒ</span>`
                            : `<span class="fee-undefined">0 å…ƒ (è¦å‰‡æœªå®šç¾©)</span>`;

                        const itemHtml = `
                            <div class="registration-item flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                <!-- æ–°å¢ç·¨è™Ÿ -->
                                <div class="hidden sm:block text-3xl font-extrabold text-red-500 mr-4">${sequenceNumber}.</div>

                                <div class="mb-2 sm:mb-0 flex-grow">
                                    <p class="text-xl font-bold text-gray-900"><span class="sm:hidden text-2xl font-extrabold text-red-500 mr-2">${sequenceNumber}.</span>${reg.name}</p>
                                    <!-- å ±åæ™‚é–“ -->
                                    <p class="text-base text-gray-600 font-normal mt-1">å ±åæ™‚é–“: <span class="text-blue-700 font-medium">${formattedTime}</span></p>
                                </div>
                                
                                <div class="flex flex-col sm:flex-row sm:space-x-8 text-lg font-medium text-gray-700 mt-2 sm:mt-0">
                                    <p>äººæ•¸/è»Šè¼›: <span class="text-blue-600">${reg.people} äºº / ${reg.cars} è»Š</span></p>
                                    <p>æŠµé”æ—¥: <span class="text-blue-600">${arrivalDateText.substring(5).replace('-', '/')}</span> (${nightsText} æ™š)</p>
                                    <p>è²»ç”¨: ${feeDisplay}</p>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', itemHtml);
                    });
                }
                
                if (loadingMsg) loadingMsg.style.display = 'none';

            }, (error) => {
                console.error("å³æ™‚è³‡æ–™ç›£è½å¤±æ•—:", error);
                container.innerHTML = `<p class="p-6 text-center text-red-500">éŒ¯èª¤: è³‡æ–™è®€å–å¤±æ•— (${error.message})</p>`;
            });
        }

        // æäº¤å ±åè¡¨å–®
        window.submitRegistration = async () => {
            if (!db || !auth.currentUser) {
                displayMessage('ç³»çµ±æ­£åœ¨åˆå§‹åŒ–ï¼Œè«‹ç¨å€™å†è©¦ã€‚', true);
                return;
            }

            const name = document.getElementById('name').value.trim();
            const cars = parseInt(document.getElementById('cars').value, 10);
            const people = parseInt(document.getElementById('people').value, 10);
            const arrivalOption = document.querySelector('input[name="arrival"]:checked');

            if (!name || isNaN(cars) || isNaN(people) || people <= 0 || !arrivalOption) {
                displayMessage('è«‹æª¢æŸ¥æ‰€æœ‰æ¬„ä½æ˜¯å¦éƒ½æ­£ç¢ºå¡«å¯«ï¼Œäººæ•¸å¿…é ˆå¤§æ–¼ 0ã€‚', true);
                return;
            }

            const [arrivalDate, nightsStr] = arrivalOption.value.split('_');
            const nights = parseInt(nightsStr, 10);

            const registrationData = {
                name: name,
                cars: cars,
                people: people,
                arrivalDate: arrivalDate,
                nights: nights,
                timestamp: new Date(),
                userId: userId // è¨˜éŒ„å ±åè€…çš„ç”¨æˆ¶ID (åŒ¿åæˆ–è‡ªè¨‚)
            };

            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'é€å‡ºä¸­...';

            try {
                await addDoc(collection(db, collectionPath), registrationData);
                displayMessage('ğŸ‰ å ±åæˆåŠŸï¼æ„Ÿè¬æ‚¨çš„åƒèˆ‡ã€‚');
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('name').value = '';
                document.getElementById('cars').value = '1';
                document.getElementById('people').value = '1';
                document.querySelectorAll('input[name="arrival"]').forEach(radio => radio.checked = false);

            } catch (e) {
                console.error("å¯«å…¥ Firestore éŒ¯èª¤: ", e);
                displayMessage('âŒ å ±åå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«ä¸»è¾¦äººã€‚', true);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'é€å‡ºå ±å';
            }
        };
    </script>
</body>
</html>